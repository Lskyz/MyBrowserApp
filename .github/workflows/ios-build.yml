name: iOS Build (No Signing with Fixed Paths)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Check Project and Source Files
        run: |
          echo "Directory contents:"
          ls -la
          if [ ! -d MyBrowserapp.xcodeproj ]; then echo "MyBrowserapp.xcodeproj not found!"; exit 1; fi
          if [ ! -d MyBrowserApp/MyBrowserApp ]; then echo "MyBrowserApp/MyBrowserApp directory not found!"; exit 1; fi
          if [ ! -f MyBrowserApp/MyBrowserApp/ContentView.swift ] || [ ! -f MyBrowserApp/MyBrowserApp/CustomWebView.swift ] || [ ! -f MyBrowserApp/MyBrowserApp/WebViewStateModel.swift ] || [ ! -f MyBrowserApp/MyBrowserApp/MyBrowserAppApp.swift ]; then
            echo "Required source files not found in MyBrowserApp/MyBrowserApp/!";
            ls -la MyBrowserApp/MyBrowserApp/;
            exit 1;
          fi

      - name: Generate Filelist
        run: |
          cd MyBrowserApp || exit 1
          BASE_DIR=/Users/runner/work/MyBrowserApp
          > filelist.txt
          echo "${BASE_DIR}/MyBrowserApp/ContentView.swift" >> filelist.txt
          echo "${BASE_DIR}/MyBrowserApp/CustomWebView.swift" >> filelist.txt
          echo "${BASE_DIR}/MyBrowserApp/WebViewStateModel.swift" >> filelist.txt
          echo "${BASE_DIR}/MyBrowserApp/MyBrowserAppApp.swift" >> filelist.txt
          cat filelist.txt

      - name: Build iOS App (No Signing with Fixed Filelist)
        run: |
          cd MyBrowserApp || exit 1
          xcodebuild -project ../MyBrowserapp.xcodeproj -scheme "mybrowesrapp" -sdk iphonesimulator -configuration Debug \
            -derivedDataPath ../build \
            INFOPLIST_FILE=../mybrowserapp/info.plist \
            SRCROOT=/Users/runner/work/MyBrowserApp \
            SWIFT_FILELIST=$(pwd)/filelist.txt \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            -archivePath ../build/mybrowesrapp.xcarchive \
            archive

      - name: Convert to IPA
        run: |
          cd MyBrowserApp || exit 1
          xcodebuild -exportArchive \
            -archivePath ../build/mybrowesrapp.xcarchive \
            -exportPath ../build/mybrowesrapp \
            -exportOptionsPlist ../exportOptions.plist \
            -allowProvisioningUpdates

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: mybrowesrapp-ipa
          path: ../build/mybrowesrapp/*.ipa