name: iOS Build (No Signing with Xcodeproj - Separate Source Fix)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Check Project and Source Files
        run: |
          echo "Directory contents:"
          ls -la
          if [ ! -d MyBrowserapp.xcodeproj ]; then echo "MyBrowserapp.xcodeproj not found!"; exit 1; fi
          if [ ! -f MyBrowserapp.xcodeproj/project.pbxproj ]; then echo "project.pbxproj not found!"; exit 1; fi
          if [ ! -d MyBrowserApp ]; then echo "MyBrowserApp directory not found!"; exit 1; fi
          find MyBrowserApp -name "*.swift" -exec echo "Found: {}" \; || echo "No .swift files found!"

      - name: Fix Line Endings for project.pbxproj
        run: |
          dos2unix ../MyBrowserapp.xcodeproj/project.pbxproj || true
          file ../MyBrowserapp.xcodeproj/project.pbxproj

      - name: Parse project.pbxproj and Validate File Paths
        run: |
          cd MyBrowserApp || exit 1
          BASE_DIR=/Users/runner/work/MyBrowserApp
          > filelist.txt
          # PBXFileReference에서 .swift 파일 경로 추출
          grep -A 6 "PBXFileReference" ../MyBrowserapp.xcodeproj/project.pbxproj | \
          grep -E "path = .*swift" | \
          awk -F' = ' '{print $2}' | \
          sed 's/[;" ]//g' | \
          while read -r path; do
            # 윈도우 경로 변환
            path=$(echo "$path" | sed 's|\\|/|g')
            full_path="${BASE_DIR}/${path}"
            if [ -f "$full_path" ]; then
              echo "$full_path" >> filelist.txt
            else
              echo "Warning: $full_path not found, searching..."
              find "$BASE_DIR" -name "$(basename "$path")" -exec echo {} >> filelist.txt \;
            fi
          done
          # 중복 제거 및 빈 줄 제거
          sort -u filelist.txt -o filelist.txt
          sed -i '' '/^$/d' filelist.txt
          if [ ! -s filelist.txt ]; then
            echo "filelist.txt is empty! Check project.pbxproj or file locations."
            exit 1
          fi
          cat filelist.txt

      - name: Build iOS App (No Signing with Parsed Filelist)
        run: |
          cd MyBrowserApp || exit 1
          xcodebuild -project ../MyBrowserapp.xcodeproj -scheme "mybrowesrapp" -sdk iphonesimulator -configuration Debug \
            -derivedDataPath ../build \
            INFOPLIST_FILE=../mybrowserapp/info.plist \
            SRCROOT=/Users/runner/work/MyBrowserApp \
            SWIFT_FILELIST=$(pwd)/filelist.txt \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            -archivePath ../build/mybrowesrapp.xcarchive \
            archive

      - name: Convert to IPA
        run: |
          cd MyBrowserApp || exit 1
          xcodebuild -exportArchive \
            -archivePath ../build/mybrowesrapp.xcarchive \
            -exportPath ../build/mybrowesrapp \
            -exportOptionsPlist ../exportOptions.plist \
            -allowProvisioningUpdates

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: mybrowesrapp-ipa
          path: ../build/mybrowesrapp/*.ipa